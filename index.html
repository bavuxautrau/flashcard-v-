<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Web Há»c Tá»« Vá»±ng IPA + SM-2</title>
<style>
body { font-family: Arial, sans-serif; background:#f0f8ff; display:flex; flex-direction:column; align-items:center; padding:20px;}
h1 { color:#333; }
.flashcard { width:350px; height:200px; border:2px solid #333; border-radius:10px; display:flex; justify-content:center; align-items:center; text-align:center; background-color:#fff; margin:20px; font-size:24px; cursor:pointer; transition: transform 0.6s; transform-style: preserve-3d; perspective:1000px; position:relative;}
.flashcard.flipped { transform: rotateY(180deg);}
.front, .back { position:absolute; width:320px; height:180px; backface-visibility:hidden; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:10px; padding:10px;}
.back { transform: rotateY(180deg); background-color:#ffe4e1;}
input, button, select { margin:5px; padding:5px; font-size:16px;}
table { border-collapse: collapse; margin-top:10px; max-width:90%;}
th, td { border:1px solid #333; padding:5px 10px; text-align:center;}
.phonetic { font-size:16px; margin-top:5px; color:#555;}
#resultPronounce { margin-top:10px; font-weight:bold; color:#006400; }
</style>
</head>
<body>

<h1>Web Há»c Tá»« Vá»±ng IPA + SM-2</h1>

<!-- Flashcard -->
<div class="flashcard" id="flashcard">
  <div class="front" id="front">Click Ä‘á»ƒ láº­t</div>
  <div class="back" id="back"></div>
</div>

<!-- CÃ¡c nÃºt chá»©c nÄƒng -->
<div>
  <input type="text" id="newWord" placeholder="Tá»« tiáº¿ng Anh">
  <input type="text" id="newMeaning" placeholder="NghÄ©a tiáº¿ng Viá»‡t">
  <input type="text" id="newCategory" placeholder="Danh má»¥c (tá»± nháº­p)">
  <button onclick="addWord()">ThÃªm tá»« má»›i</button>
  <button onclick="nextWord()">Tá»« tiáº¿p theo</button>
  <button onclick="markKnown()">ÄÃ£ thuá»™c</button>
  <button onclick="reviewKnown()">Ã”n láº¡i tá»« Ä‘Ã£ thuá»™c</button>
  <button onclick="playPronunciation()">PhÃ¡t Ã¢m</button>
  <button id="speakBtn">ğŸ¤ NÃ³i tá»« nÃ y</button>
  <button onclick="requestNotificationPermission()">ğŸ”” Báº­t thÃ´ng bÃ¡o</button>
</div>

<p id="resultPronounce"></p>

<!-- Báº£ng danh sÃ¡ch tá»« -->
<h3>Danh sÃ¡ch tá»« (Sá»­a/XÃ³a)</h3>
<select id="filterCategory" onchange="renderTable()">
  <option value="">Táº¥t cáº£ danh má»¥c</option>
</select>
<table id="wordTable">
  <thead>
    <tr><th>Tá»«</th><th>NghÄ©a</th><th>Danh má»¥c</th><th>ÄÃ£ thuá»™c</th><th>HÃ nh Ä‘á»™ng</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// ==========================
// Dá»¯ liá»‡u tá»« vá»±ng
// ==========================
let words = JSON.parse(localStorage.getItem('words')) || [
  {eng:"apple", vi:"quáº£ tÃ¡o", category:"Äá»“ Äƒn", known:false, lastReview:Date.now(), interval:1, phonetic:"ËˆÃ¦p(É™)l"},
  {eng:"cat", vi:"con mÃ¨o", category:"Äá»™ng váº­t", known:false, lastReview:Date.now(), interval:1, phonetic:"kÃ¦t"}
];
let currentIndex = 0;
let inReviewMode = false;

// ==========================
// DOM elements
// ==========================
const flashcard = document.getElementById("flashcard");
const front = document.getElementById("front");
const back = document.getElementById("back");
const wordTable = document.querySelector("#wordTable tbody");
const filterCategory = document.getElementById("filterCategory");
const speakBtn = document.getElementById("speakBtn");
const resultPronounce = document.getElementById("resultPronounce");

// ==========================
// Flashcard
// ==========================
async function showWord() {
  let activeWords = inReviewMode ? words.filter(w=>w.known) : words.filter(w=>!w.known);
  if(filterCategory.value) activeWords = activeWords.filter(w=>w.category===filterCategory.value);
  if(activeWords.length===0){
    front.textContent = inReviewMode?"ChÆ°a cÃ³ tá»« Ä‘á»ƒ Ã´n!":"Báº¡n Ä‘Ã£ há»c háº¿t tá»« má»›i!";
    back.innerHTML = "";
    return;
  }
  currentIndex = currentIndex % activeWords.length;
  let word = activeWords[currentIndex];

  front.textContent = word.eng;

  // Láº¥y IPA thá»±c náº¿u chÆ°a cÃ³
  if(!word.phonetic) word.phonetic = await fetchIPA(word.eng);

  back.innerHTML = `${word.vi} <div class="phonetic">[${word.phonetic}]</div>`;
  localStorage.setItem('words', JSON.stringify(words));
  flashcard.classList.remove("flipped");
}

flashcard.addEventListener("click", ()=>{ flashcard.classList.toggle("flipped"); });
function nextWord(){ currentIndex++; showWord(); }

// ==========================
// PhÃ¡t Ã¢m
// ==========================
function playPronunciation(){
  let activeWords = inReviewMode ? words.filter(w=>w.known) : words.filter(w=>!w.known);
  if(filterCategory.value) activeWords = activeWords.filter(w=>w.category===filterCategory.value);
  if(activeWords.length===0) return;
  const utterance = new SpeechSynthesisUtterance(activeWords[currentIndex].eng);
  utterance.lang = 'en-US';
  utterance.rate = 0.9;
  speechSynthesis.speak(utterance);
}

// ==========================
// Luyá»‡n phÃ¡t Ã¢m báº±ng micro
// ==========================
let recognition;
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = "en-US"; // giá»ng Má»¹
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onresult = (event) => {
    let spokenText = event.results[0][0].transcript.trim().toLowerCase();
    let activeWords = inReviewMode ? words.filter(w=>w.known) : words.filter(w=>!w.known);
    if(filterCategory.value) activeWords = activeWords.filter(w=>w.category===filterCategory.value);
    if(activeWords.length===0) return;
    let correctWord = activeWords[currentIndex].eng.toLowerCase();
    if (spokenText === correctWord) {
      resultPronounce.textContent = `âœ… Chuáº©n rá»“i: ${spokenText}`;
      setTimeout(()=>{ nextWord(); }, 1000);
    } else {
      resultPronounce.textContent = `âŒ Báº¡n nÃ³i: "${spokenText}", cáº§n: "${correctWord}"`;
    }
  };

  recognition.onerror = (event) => {
    resultPronounce.textContent = "âš  Lá»—i nháº­n diá»‡n giá»ng nÃ³i: " + event.error;
  };
} else {
  resultPronounce.textContent = "TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ nháº­n diá»‡n giá»ng nÃ³i!";
}

speakBtn.addEventListener("click", ()=>{
  if(recognition) {
    resultPronounce.textContent = "ğŸ¤ Äang nghe...";
    recognition.start();
  }
});

// ==========================
// ThÃ´ng bÃ¡o (Notification API)
// ==========================
function requestNotificationPermission() {
  Notification.requestPermission().then(permission => {
    if (permission === "granted") {
      alert("âœ… Báº¡n Ä‘Ã£ báº­t thÃ´ng bÃ¡o!");
    } else {
      alert("âŒ Báº¡n khÃ´ng cho phÃ©p thÃ´ng bÃ¡o!");
    }
  });
}

function scheduleNotifications(word){
  if(Notification.permission !== "granted") return;
  let times = [5*60*1000, 20*60*1000, 40*60*1000, 2*60*60*1000, 10*60*60*1000, 24*60*60*1000]; 
  times.forEach((t)=>{
    setTimeout(()=>{
      new Notification("Ã”n tá»« vá»±ng", { body: `HÃ£y Ã´n láº¡i tá»«: ${word.eng} (${word.vi})` });
    }, t);
  });
}

// ==========================
// Láº¥y IPA tá»« DictionaryAPI
// ==========================
async function fetchIPA(word){
  try {
    let res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    let data = await res.json();
    if(data[0] && data[0].phonetics && data[0].phonetics.length>0){
      for(let p of data[0].phonetics){
        if(p.text) return p.text; 
      }
    }
    return generateFakeIPA(word);
  } catch(e){ console.log(e); return generateFakeIPA(word); }
}
function generateFakeIPA(word){ return word.toLowerCase().split("").join("."); }

// ==========================
// ThÃªm/Sá»­a/XÃ³a tá»«
// ==========================
function addWord(){
  const eng = document.getElementById("newWord").value.trim();
  const vi = document.getElementById("newMeaning").value.trim() || eng;
  const category = document.getElementById("newCategory").value.trim() || "KhÃ¡c";
  if(!eng) return alert("Vui lÃ²ng nháº­p tá»« tiáº¿ng Anh!");
  let now = Date.now();
  words.push({eng, vi, category, known:false, lastReview:now, interval:1, phonetic:""});
  localStorage.setItem('words', JSON.stringify(words));
  document.getElementById("newWord").value=""; document.getElementById("newMeaning").value=""; document.getElementById("newCategory").value="";
  updateCategoryOptions(); inReviewMode=false; showWord(); renderTable();
}

function editWord(index){
  let word = words[index];
  let newEng = prompt("Sá»­a tá»« tiáº¿ng Anh:", word.eng);
  if(!newEng) return;
  let newVi = prompt("Sá»­a nghÄ©a tiáº¿ng Viá»‡t:", word.vi) || newEng;
  let newCategory = prompt("Sá»­a danh má»¥c:", word.category) || "KhÃ¡c";
  word.eng=newEng; word.vi=newVi; word.category=newCategory; word.phonetic="";
  localStorage.setItem('words', JSON.stringify(words));
  updateCategoryOptions(); renderTable(); showWord();
}

function deleteWord(index){
  if(!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a tá»« nÃ y?")) return;
  words.splice(index,1);
  localStorage.setItem('words', JSON.stringify(words));
  updateCategoryOptions(); renderTable(); showWord();
}

// ==========================
// SM-2 & ÄÃ¡nh dáº¥u Ä‘Ã£ thuá»™c
// ==========================
function markKnown(){
  let activeWords = words.filter(w=>!w.known);
  if(filterCategory.value) activeWords = activeWords.filter(w=>w.category===filterCategory.value);
  if(activeWords.length===0) return;
  let word = activeWords[currentIndex];
  word.known=true;
  word.lastReview=Date.now();
  word.interval = nextInterval(word.interval);
  localStorage.setItem('words', JSON.stringify(words));
  
  // ğŸ”” LÃªn lá»‹ch thÃ´ng bÃ¡o Ã´n táº­p
  scheduleNotifications(word);

  inReviewMode=false; showWord(); renderTable();
}

function nextInterval(prev){
  if(prev<3) return 3;
  if(prev<7) return 7;
  if(prev<14) return 14;
  if(prev<30) return 30;
  return 30;
}

// ==========================
// Ã”n láº¡i tá»« Ä‘Ã£ thuá»™c
// ==========================
function reviewKnown(){
  let knownWords = words.filter(w=>w.known);
  if(filterCategory.value) knownWords = knownWords.filter(w=>w.category===filterCategory.value);
  if(knownWords.length===0) return alert("ChÆ°a cÃ³ tá»« nÃ o Ä‘á»ƒ Ã´n!");
  inReviewMode=true; currentIndex=0; showWord();
}

// ==========================
// Danh sÃ¡ch tá»«
// ==========================
function renderTable(){
  wordTable.innerHTML="";
  const selectedCat = filterCategory.value;
  words.forEach((w,i)=>{
    if(selectedCat && w.category!==selectedCat) return;
    let tr = document.createElement("tr");
    tr.innerHTML = `<td>${w.eng}</td><td>${w.vi}</td><td>${w.category}</td><td>${w.known?"âœ”":"âŒ"}</td>
    <td><button onclick="editWord(${i})">Sá»­a</button> <button onclick="deleteWord(${i})">XÃ³a</button></td>`;
    wordTable.appendChild(tr);
  });
}

// ==========================
// Cáº­p nháº­t danh má»¥c
// ==========================
function updateCategoryOptions(){
  let categories = [...new Set(words.map(w=>w.category))];
  filterCategory.innerHTML='<option value="">Táº¥t cáº£ danh má»¥c</option>';
  categories.forEach(cat=>{
    let option = document.createElement("option");
    option.value=cat; option.textContent=cat;
    filterCategory.appendChild(option);
  });
}

// ==========================
// Khá»Ÿi táº¡o
// ==========================
updateCategoryOptions();
showWord();
renderTable();
</script>
</body>
</html>
