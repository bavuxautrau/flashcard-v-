<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Web Há»c Tá»« Vá»±ng IPA + SM-2 + áº¢nh URL</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body { font-family: Arial, sans-serif; background:#f0f8ff; display:flex; flex-direction:column; align-items:center; padding:18px; }
h1 { color:#333; margin:6px 0 14px 0; }
.flashcard { width:360px; height:300px; border:2px solid #333; border-radius:10px; display:flex; justify-content:center; align-items:center; text-align:center; background-color:#fff; margin:12px; font-size:24px; cursor:pointer; transition: transform 0.6s; transform-style: preserve-3d; perspective:1000px; position:relative; }
.flashcard.flipped { transform: rotateY(180deg); }
.front, .back { position:absolute; width:320px; height:260px; backface-visibility:hidden; display:flex; flex-direction:column; justify-content:flex-start; align-items:center; border-radius:10px; padding:12px; box-sizing:border-box; overflow:auto; }
.back { transform: rotateY(180deg); background-color:#fff6f2; }
.phonetic { font-size:15px; margin-top:8px; color:#444; font-style:italic; }
.flash-img { max-width:90%; max-height:140px; margin-top:10px; border-radius:8px; object-fit:cover; border:1px solid #ddd; }
.controls, .inputs { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:8px 0; }
.inputs input[type="text"] { padding:8px; font-size:15px; width:180px; border-radius:6px; border:1px solid #bbb; }
button { padding:8px 10px; border-radius:6px; border:1px solid #888; background:#fff; cursor:pointer; }
.small { padding:6px 8px; font-size:14px; }
table { border-collapse: collapse; margin-top:10px; width:90%; max-width:960px; }
th, td { border:1px solid #333; padding:6px 8px; text-align:center; font-size:14px; }
.thumbnail { width:60px; height:40px; object-fit:cover; border-radius:4px; }
#resultPronounce { margin-top:8px; font-weight:600; color:#006400; min-height:20px; }
.note { font-size:13px; color:#666; margin-top:4px; }
</style>
</head>
<body>

<h1>Web Há»c Tá»« Vá»±ng IPA + SM-2 + áº¢nh</h1>

<!-- Flashcard -->
<div class="flashcard" id="flashcard" title="Báº¥m Ä‘á»ƒ láº­t">
  <div class="front" id="front">Click Ä‘á»ƒ láº­t</div>
  <div class="back" id="back"></div>
</div>

<!-- Inputs: tá»«, nghÄ©a, danh má»¥c, URL áº£nh -->
<div class="inputs">
  <input type="text" id="newWord" placeholder="Tá»« tiáº¿ng Anh (vd: dog)">
  <input type="text" id="newMeaning" placeholder="NghÄ©a tiáº¿ng Viá»‡t">
  <input type="text" id="newCategory" placeholder="Danh má»¥c (vd: Ä‘á»™ng váº­t)">
  <input type="text" id="newImage" placeholder="URL áº£nh (tÃ¹y chá»n)">
</div>

<div class="controls">
  <button onclick="pasteImageUrl()" class="small">ğŸ“‹ DÃ¡n URL áº£nh</button>
  <button onclick="setUnsplashToInput()" class="small">ğŸ”€ áº¢nh Unsplash (tá»«)</button>
  <button onclick="addWord()">â• ThÃªm tá»« má»›i</button>
  <button onclick="nextWord()">â­ Tá»« tiáº¿p theo</button>
  <button onclick="markKnown()">âœ… ÄÃ£ thuá»™c</button>
  <button onclick="markUnknown()" class="small">âŒ ChÆ°a thuá»™c</button>
  <button onclick="playPronunciation()" class="small">ğŸ”Š PhÃ¡t Ã¢m</button>
  <button id="speakBtn" class="small">ğŸ¤ NÃ³i tá»«</button>
  <button onclick="copyCurrentImageUrl()" class="small">ğŸ“‹ Sao chÃ©p URL áº£nh hiá»‡n táº¡i</button>
  <button onclick="changeUnsplashImage()" class="small">ğŸ”„ Äá»•i áº£nh (Unsplash)</button>
  <button onclick="requestNotificationPermission()" class="small">ğŸ”” Báº­t thÃ´ng bÃ¡o</button>
</div>

<p id="resultPronounce"></p>
<p class="note">Ghi chÃº: náº¿u nháº­p URL áº£nh, flashcard sáº½ dÃ¹ng áº£nh Ä‘Ã³; náº¿u Ä‘á»ƒ trá»‘ng, áº£nh tá»± Ä‘á»™ng láº¥y tá»« Unsplash dá»±a trÃªn tá»«.</p>

<!-- Danh sÃ¡ch tá»« -->
<h3>Danh sÃ¡ch tá»« (Sá»­a / XÃ³a / áº¢nh)</h3>
<select id="filterCategory" onchange="renderTable()">
  <option value="">Táº¥t cáº£ danh má»¥c</option>
</select>
<table id="wordTable">
  <thead>
    <tr><th>Tá»«</th><th>NghÄ©a</th><th>Danh má»¥c</th><th>áº¢nh</th><th>ÄÃ£ thuá»™c</th><th>HÃ nh Ä‘á»™ng</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// ========== Dá»¯ liá»‡u ========== //
let words = JSON.parse(localStorage.getItem('words')) || [
  {eng:"apple", vi:"quáº£ tÃ¡o", category:"Äá»“ Äƒn", image:"", known:false, lastReview:Date.now(), interval:1, phonetic:"ËˆÃ¦p(É™)l"},
  {eng:"cat", vi:"con mÃ¨o", category:"Äá»™ng váº­t", image:"", known:false, lastReview:Date.now(), interval:1, phonetic:"kÃ¦t"}
];
let currentIndex = 0;
let mode = "unknown"; // "unknown" = há»c tá»« chÆ°a thuá»™c, "known" = Ã´n láº¡i tá»« Ä‘Ã£ thuá»™c

// ========== DOM ========== //
const flashcard = document.getElementById('flashcard');
const front = document.getElementById('front');
const back = document.getElementById('back');
const wordTable = document.querySelector('#wordTable tbody');
const filterCategory = document.getElementById('filterCategory');
const speakBtn = document.getElementById('speakBtn');
const resultPronounce = document.getElementById('resultPronounce');

// ========== Flashcard show ========== //
function getActiveWords(){
  let list = (mode === "known") ? words.filter(w=>w.known) : words.filter(w=>!w.known);
  if(filterCategory.value) list = list.filter(w => w.category === filterCategory.value);
  return list;
}

async function showWord(){
  const activeWords = getActiveWords();
  if(activeWords.length === 0){
    front.textContent = (mode==="known") ? "ChÆ°a cÃ³ tá»« Ä‘á»ƒ Ã´n!" : "KhÃ´ng cÃ³ tá»« Ä‘á»ƒ há»c!";
    back.innerHTML = "";
    return;
  }
  // ensure currentIndex in range
  currentIndex = currentIndex % activeWords.length;
  const w = activeWords[currentIndex];

  // set front
  front.textContent = w.eng;

  // fetch phonetic if empty
  if(!w.phonetic) {
    w.phonetic = await fetchIPA(w.eng);
  }

  // ensure image: if user provided image URL use it; else auto-unsplash
  if(!w.image) {
    w.image = getUnsplashUrl(w.eng);
  }

  // build back content (vi, ipa, image) â€” stable assignment so flipping doesn't clear
  let imgHtml = '';
  if(w.image){
    // sanitize (simple) â€” set as-is; browser will block invalid urls.
    imgHtml = `<img src="${w.image}" alt="${escapeHtml(w.eng)}" class="flash-img">`;
  }
  back.innerHTML = `
    <div style="font-size:18px; font-weight:600; margin-top:6px;">${escapeHtml(w.vi)}</div>
    <div class="phonetic">[${escapeHtml(w.phonetic)}]</div>
    ${imgHtml}
  `;

  // persist
  localStorage.setItem('words', JSON.stringify(words));
  flashcard.classList.remove('flipped');
}

// safe minimal escape
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

// flip behavior
flashcard.addEventListener('click', ()=> flashcard.classList.toggle('flipped'));
function nextWord(){ currentIndex++; showWord(); }

// ========== Speech Synthesis ========== //
function playPronunciation(){
  const activeWords = getActiveWords();
  if(activeWords.length === 0) return;
  const w = activeWords[currentIndex];
  const u = new SpeechSynthesisUtterance(w.eng);
  u.lang = 'en-US';
  u.rate = 0.95;
  speechSynthesis.speak(u);
}

// ========== Speech Recognition (kiá»ƒm tra phÃ¡t Ã¢m) ========== //
let recognition;
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onresult = (ev) => {
    const activeWords = getActiveWords();
    if(activeWords.length === 0) return;
    const spoken = ev.results[0][0].transcript.trim().toLowerCase();
    const expected = activeWords[currentIndex].eng.trim().toLowerCase();
    // normalize small punctuation
    const normalize = s => s.replace(/[^a-z']/g,'').toLowerCase();
    if(normalize(spoken) === normalize(expected)){
      resultPronounce.textContent = `âœ… Chuáº©n rá»“i: ${spoken}`;
      setTimeout(()=> nextWord(), 900);
    } else {
      resultPronounce.textContent = `âŒ Báº¡n nÃ³i: "${spoken}", cáº§n: "${expected}"`;
    }
  };

  recognition.onerror = (ev) => {
    resultPronounce.textContent = "âš  Lá»—i nháº­n diá»‡n giá»ng nÃ³i: " + (ev.error||'unknown');
  };
} else {
  resultPronounce.textContent = "TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ nháº­n diá»‡n giá»ng nÃ³i.";
}

speakBtn.addEventListener('click', ()=> {
  if(recognition){
    resultPronounce.textContent = "ğŸ¤ Äang nghe...";
    recognition.start();
  } else {
    resultPronounce.textContent = "âš  TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ nháº­n diá»‡n giá»ng nÃ³i.";
  }
});

// ========== Notifications ========== //
function requestNotificationPermission(){
  if(!('Notification' in window)) { alert('TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ Notification API'); return; }
  Notification.requestPermission().then(p=>{
    alert(p === 'granted' ? 'âœ… Báº¡n Ä‘Ã£ báº­t thÃ´ng bÃ¡o!' : 'âŒ Báº¡n khÃ´ng cho phÃ©p thÃ´ng bÃ¡o!');
  });
}
function scheduleNotifications(word){
  if(Notification.permission !== 'granted') return;
  const times = [5*60*1000, 20*60*1000, 40*60*1000, 2*60*60*1000, 10*60*60*1000, 24*60*60*1000];
  times.forEach(t=>{
    setTimeout(()=> new Notification('Ã”n tá»« vá»±ng', { body: `HÃ£y Ã´n láº¡i tá»«: ${word.eng} â€” ${word.vi}` }), t);
  });
}

// ========== IPA fetch ========== //
async function fetchIPA(word){
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
    const data = await res.json();
    if(Array.isArray(data) && data[0] && data[0].phonetics && data[0].phonetics.length){
      const p = data[0].phonetics.find(x=>x.text);
      if(p) return p.text;
    }
    return generateFakeIPA(word);
  } catch(e){
    return generateFakeIPA(word);
  }
}
function generateFakeIPA(word){
  return word.split('').join('.');
}

// ========== áº¢nh: Unsplash helper ========== //
function getUnsplashUrl(word){
  // use signature to avoid caching same image when needed
  return `https://source.unsplash.com/600x400/?${encodeURIComponent(word)}&sig=${Date.now()}`;
}

// ========== Clipboard helpers ========== //
async function pasteImageUrl(){
  if(!navigator.clipboard) { alert('TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ Clipboard API'); return; }
  try {
    const txt = await navigator.clipboard.readText();
    document.getElementById('newImage').value = txt;
  } catch(e){
    alert('KhÃ´ng thá»ƒ Ä‘á»c clipboard: ' + e);
  }
}
async function copyToClipboard(text){
  if(!navigator.clipboard) { alert('TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ Clipboard API'); return; }
  try { await navigator.clipboard.writeText(text); alert('ÄÃ£ sao chÃ©p URL áº£nh'); }
  catch(e){ alert('KhÃ´ng thá»ƒ sao chÃ©p: '+e); }
}
function copyCurrentImageUrl(){
  const active = getActiveWords();
  if(active.length===0){ alert('KhÃ´ng cÃ³ áº£nh'); return; }
  const w = active[currentIndex];
  if(!w || !w.image) { alert('Hiá»‡n táº¡i khÃ´ng cÃ³ URL áº£nh Ä‘á»ƒ sao chÃ©p'); return; }
  copyToClipboard(w.image);
}

// ========== ThÃªm / Sá»­a / XÃ³a tá»« ========== //
function addWord(){
  const eng = document.getElementById('newWord').value.trim();
  const vi = document.getElementById('newMeaning').value.trim() || eng;
  const category = document.getElementById('newCategory').value.trim() || 'KhÃ¡c';
  const image = (document.getElementById('newImage').value || '').trim();
  if(!eng){ alert('Vui lÃ²ng nháº­p tá»« tiáº¿ng Anh'); return; }
  words.push({eng, vi, category, image, known:false, lastReview:Date.now(), interval:1, phonetic:""});
  localStorage.setItem('words', JSON.stringify(words));
  // clear inputs
  document.getElementById('newWord').value='';
  document.getElementById('newMeaning').value='';
  document.getElementById('newCategory').value='';
  document.getElementById('newImage').value='';
  updateCategoryOptions();
  mode = 'unknown';
  // show the newly added word (last added)
  const active = getActiveWords();
  const idx = active.findIndex(w => w.eng === eng && w.vi === vi);
  if(idx >= 0) currentIndex = idx;
  showWord();
  renderTable();
}

function editWord(i){
  // edit from global words array index i
  const w = words[i];
  if(!w) return;
  const newEng = prompt('Sá»­a tá»« (tiáº¿ng Anh):', w.eng);
  if(!newEng) return;
  const newVi = prompt('Sá»­a nghÄ©a (tiáº¿ng Viá»‡t):', w.vi) || newEng;
  const newCategory = prompt('Sá»­a danh má»¥c:', w.category) || 'KhÃ¡c';
  const newImage = prompt('Sá»­a URL áº£nh (Ä‘á»ƒ trá»‘ng = auto Unsplash):', w.image || '') || '';
  w.eng = newEng.trim();
  w.vi = newVi.trim();
  w.category = newCategory.trim();
  w.image = newImage.trim();
  w.phonetic = '';
  localStorage.setItem('words', JSON.stringify(words));
  updateCategoryOptions();
  renderTable();
  showWord();
}

function deleteWord(i){
  if(!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a tá»« nÃ y?')) return;
  words.splice(i,1);
  localStorage.setItem('words', JSON.stringify(words));
  updateCategoryOptions();
  renderTable();
  // ensure current index valid
  currentIndex = 0;
  showWord();
}

// ========== ÄÃ¡nh dáº¥u Ä‘Ã£ thuá»™c / chÆ°a ========== //
function markKnown(){
  const active = getActiveWords();
  if(active.length === 0) return;
  const w = active[currentIndex];
  // find in global array and update
  const idx = words.findIndex(x => x.eng === w.eng && x.vi === w.vi && x.category === w.category);
  if(idx >= 0){ words[idx].known = true; words[idx].lastReview = Date.now(); localStorage.setItem('words', JSON.stringify(words)); scheduleNotifications(words[idx]); }
  // stay in same mode or return to unknown mode
  mode = 'unknown';
  showWord();
  renderTable();
}
function markUnknown(){
  const active = getActiveWords();
  if(active.length === 0) return;
  const w = active[currentIndex];
  const idx = words.findIndex(x => x.eng === w.eng && x.vi === w.vi && x.category === w.category);
  if(idx >= 0){ words[idx].known = false; localStorage.setItem('words', JSON.stringify(words)); }
  showWord();
  renderTable();
}

// ========== Mode control ========== //
function reviewKnown(){ mode = 'known'; currentIndex = 0; showWord(); }
function reviewUnknown(){ mode = 'unknown'; currentIndex = 0; showWord(); }

// ========== Unsplash controls ========== //
function setUnsplashToInput(){
  const w = document.getElementById('newWord').value.trim();
  if(!w){ alert('Nháº­p tá»« vÃ o Ã´ Tá»« tiáº¿ng Anh trÆ°á»›c'); return; }
  document.getElementById('newImage').value = getUnsplashUrl(w);
}
function changeUnsplashImage(){
  const active = getActiveWords();
  if(active.length === 0) return;
  const w = active[currentIndex];
  const idx = words.findIndex(x => x.eng === w.eng && x.vi === w.vi && x.category === w.category);
  if(idx >= 0){
    words[idx].image = getUnsplashUrl(w.eng);
    localStorage.setItem('words', JSON.stringify(words));
    showWord();
    renderTable();
  }
}

// ========== Table render & categories ========== //
function renderTable(){
  wordTable.innerHTML = '';
  const sel = filterCategory.value;
  words.forEach((w,i) => {
    if(sel && w.category !== sel) return;
    const tr = document.createElement('tr');
    const thumb = w.image ? `<img src="${w.image}" class="thumbnail" alt="thumb">` : '';
    tr.innerHTML = `<td>${escapeHtml(w.eng)}</td>
      <td>${escapeHtml(w.vi)}</td>
      <td>${escapeHtml(w.category)}</td>
      <td>${thumb || 'â€”'}</td>
      <td>${w.known ? 'âœ”' : 'âŒ'}</td>
      <td>
        <button onclick="editWord(${i})">Sá»­a</button>
        <button onclick="deleteWord(${i})">XÃ³a</button>
        <button onclick="setImageUrlPrompt(${i})">âœï¸ áº¢nh</button>
      </td>`;
    wordTable.appendChild(tr);
  });
}
function setImageUrlPrompt(i){
  const w = words[i];
  const newUrl = prompt('Nháº­p URL áº£nh (Ä‘á»ƒ trá»‘ng = tá»± Ä‘á»™ng Unsplash):', w.image || '') || '';
  w.image = newUrl.trim();
  localStorage.setItem('words', JSON.stringify(words));
  renderTable();
  showWord();
}

function updateCategoryOptions(){
  const cats = [...new Set(words.map(w => w.category).filter(Boolean))];
  filterCategory.innerHTML = '<option value="">Táº¥t cáº£ danh má»¥c</option>';
  cats.forEach(c => {
    const opt = document.createElement('option'); opt.value = c; opt.textContent = c;
    filterCategory.appendChild(opt);
  });
}

// ========== Init ========== //
updateCategoryOptions();
showWord();
renderTable();
</script>
</body>
</html>
